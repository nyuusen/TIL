# WebAPI The Good Parts

# 1章 WebAPIとは何か

- 本書でのWebAPIの定義は「HTTPプロトコルを利用してネットワーク越しに呼び出すAPI」

# 2章 エンドポイントの設計とリクエストの形式

- 良いエンドポイント設計
  - **覚えやすくどんな機能を持つURIなのかが一目で分かる**
  - 具体的には、
    - 短い
    - 人間が読める
    - 省略形は使わない
    - 大文字小文字混在させない
    - 単数系複数形、パラメータ指定方法を統一する
    - 内部のアーキテクチャを露出しない
      - URLにcgiが入っているとか
      - 内部で利用している識別子が露出しているとか
- HTTPメソッド
  - POST
    - 新しいリソースを送信する・登録する
    - 既存の更新・修正・削除はPUT・DELETEが本来は正しい
  - PUT
    - 既存リソースの完全上書き
  - PATCH
    - 既存リソースの一部を変更する
  - X-HTTP-Method-Overrideヘッダ
    - 古いブラウザや一部のライブラリなどではPATCHやDELETEなどのメソッドに対応していないケースがある
    - そういったケースに対する対応策としては、以下の2つがある
      - X-HTTP-Method-Overrideヘッダ
        - リクエスト自体はPOSTにして、X-HTTP-Method-Overrideヘッダに本来使用した値(DELETEなど)を設定する
      - _methodパラメータ
        - Formのパラメータの1つとして、application/x-www-form-urlencodedというContent typeで表されるデータの一部として送信される
          - `user=test&_method=PUT`
    - X-HTTP-Method-Overrideヘッダの方が好ましい（理由：_methodはContentTypeが限られるのと、リクエスト本文に関係のないメタ情報が入ってしまう点が微妙）
    - ちなみにX-HTTP-Method-Overrideヘッダを使用すると、一旦ブラウザからはPOSTで送信するけど、サーバー側ではDELETE等で処理を行うことを期待すると言う意味合い
      - なのでサーバー側ではこのヘッダがセットされた時の実装を考慮する必要がある
- URLとメソッド
  - `user/`: 一覧系
  - `user/:id`: 詳細系
  - 上記のエンドポイントに対して、GETなら取得、POSTなら登録、DELETEなら削除といったように、エンドポイントで「あるデータの集合」や「個々のデータ」表現し、HTTPメソッドで操作を表すのがWebAPI設計の基本中の基本となる
- URL設計に関しては少しだけ深掘りしてメモを残した: https://github.com/nyuusen/TIL/blob/f8c0a5e7b01f9d2bd9b5e9fb66f658e0e8147c2f/system-design/url-path.md
- SNSでの友達削除処理について
  - `DELETE /v1/users/:id/friends/:id`というエンドポイント例に
  - 2つ目のIDを「友達のユーザーIDにするか？」「友達関係を表す別のIDにするか？」
  - 結論、「友達のユーザーIDにする」で良い
    - 理由は、
      - エンドポイントは、「自分のユーザーID＋相手のユーザーID」でユニークになっているため、固有リソースを表すことができている
      - 友達関係IDのような新たな数値が入ってくるよりも、利用者にもわかりやすい＆扱いやすいので、エンドポイント生成も容易（Hackableを満たしている）
  - **内部のアーキテクチャの都合をAPIに反映させる必要は全くない**
- 複数の単語を繋げる場合は「-」が良い
  - Google的には「-」の方がSEOが良いらしい（APIはSEO関係ないが）
  - 「_」だと、リンク表示時の下線とかぶってしまい見づらい
  - キャメルケースだと、ホスト名は英語小文字大文字の区別がつかないことを考えると一貫性に欠ける
  - 結論、特にこだわりがないなら「-」が良い
    - それ以前に、単語を繋ぎ合わせること自体極力避けた方が良い
- ページネーション検索
  - limit/offsetもしくはper_page/pageのどちらかに統一する
  - 相対位置を指定する問題点
    - データ量が増えるとSQLパフォーマンスが悪くなる
      - なぜなら先頭からカウントしていくため
    - 更新頻度が高いデータだと、リクエスト毎の整合性が取れなくなるリスクもある
  - そこで解決するための策として「絶対位置」で指定する
    - 絶対位置というのは、このIDより後ろとかこの時間より後ろとかそういうやつ
- 絞り込み検索
  - 全文検索には「q」というパラメータ名が使われることが多々ある（`?q=hoge`）
- 検索用エンドポイントとして`search`を含めるべきか？
  - まずsearch自体は動詞でありリソースではないので、そういった観点では入れるべきではない
  - ただTwitterやInstagramのような一覧すべてを取得することが困難である場合は、検索を行うためのAPIを提供しますよという訴求のためsearchを入れるのはありだと思う