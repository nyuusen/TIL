# AWS設計スキルアップガイド

## 2.クラウドのインフラ設計

### クラウドで考えるセキュリティ

- 万が一の事故や障害が発生したときに「責任分界点」を定義しておくことで、責任の所在を明らかにできる
- AWSでの「責任共有モデル」では、それぞれの責任について以下のように定義されている
  - AWS: サービスを提供するためのインフラストラクチャ
  - 利用者: 選択したAWSサービスごとの適切なセキュリティを実装し、システムを保護する
- AWS SecurityHubを使用することで、横断的にセキュリティの問題を検知することができる

## 3.システムの構成

- AWSでシステムを構築する時にまず考えるべきは「アカウントをどの単位で発行するか」

### AWSアカウントの運用例

- 単一のアカウントで運用するケース
  - 注意ポイント
    - VPCをプロジェクトや環境ごとに分離する
    - プロジェクトや環境がわかるようにタグを活用する
    - VPCに関連のないサービスを使用する場合、IAMで権限を設定する
  - 管理する請求先が1つになるメリットはあるが、誤操作等によるミスや事故リスクが上がるので、できればアカウントは分けて運用するのが良い
- 複数のアカウントで運用するケース
  - アカウントの統制を考慮する
    - AWS ControlTowerで一元管理
    - Organizationで細かい所まで完了
  - ログインIDの統合を検討する
    - 各環境のIAMロールで行う方法
    - AWS アイデンティティセンターを活用する方法
    - サードパーティIDaaSを活用する方法

### IAM

- 認証はIAMユーザー、認可はIAMポリシーで設定する
  - 通常、ポリシーはグループもしくはロールに付与する

#### IAMポリシー設計

- デフォルトはすべて拒否なので、明示的に許可していく
  - どのリソース(Resource)に対して、どんな条件で(Conditions)、どんな動作(Action)を、許可/拒否する(Effect)かをJSONもしくはGUIで記述(選択)する
- ポリシーはいくつか種類がある(使用頻度が高いものを抜粋)
  - アイデンティティベースのポリシー
    - アイデンティティ(ユーザー、グループ、ロール)にアタッチする
    - この中にも再利用可能な管理ポリシーとインラインポリシーが存在(管理ポリシー推奨)
  - リソースベースのポリシー
    - S3などのリソースにアタッチする
  - セッションポリシー
    - 一時的にセッション単位でアクセスを許可するポリシー
    - AssumeRoleなどのAPIを利用する
- ポリシー評価について
  - 以下の順番で評価される
    - ![image](https://cdn-ak.f.st-hatena.com/images/fotolife/s/swx-yamasaki/20220227/20220227092451.png)
      - 画像引用元: [【入門編】AWSにおけるアクセスポリシーの評価ロジックを整理してみる](https://blog.serverworks.co.jp/iam/policy/evaluation-logic)
  - 明示的な拒否があれば、その拒否設定が適用される
    - 拒否設定の後に、明示的な許可設定があったとしても、拒否設定が優先的に適用される
  - 明示的な許可があれば許可となるが、なかった場合は暗黙的に拒否される

## 4.ネットワーク設計

### オンプレミスとの比較

- オンプレミスと比較すると、AWSにおける設計はある程度ざっくりでOK
  - 名前解決
    - オンプレミス: 内部DNSを立てるか各サーバーのhostsファイルを利用して名前解決を行う
    - AWS: 自動でパブリックのDNS名が割り当てられ、マネージドのDNSで名前解決を行う
  - 時刻同期
    - オンプレミス: システム内の時刻が同期するように同一のNTPサーバーを割り当てる
    - AWS: AmazonTimeSyncServiceで同期する(インターネット接続不要)

### VPCとサブネット

- VPCはリージョンごとのサービスなので、リージョンを跨ぐことはできない
- サブネットではいくつかのIPアドレスがAWSの予約枠として確保されている
  - ネットワークアドレス (最初のIPアドレス)
    - 例: 10.0.0.0/24サブネットの場合、10.0.0.0がこのアドレスです。
    - 役割: ネットワーク自体を表すためのアドレスであり、ルーティングやネットワーク構成で使用されます。
  - VPCルーター (2番目のIPアドレス)
    - 例: 10.0.0.1がこのアドレスとなります（サブネットによって異なる場合もあり）。
    - 役割: サブネット内での通信を管理する仮想ルーターです。インスタンス間の通信やインターネットゲートウェイ、VPN接続の経路制御など、サブネット内のルーティングに使用されます。
  - DNSサーバー (3番目のIPアドレス)
    - 例: 10.0.0.2です。
    - 役割: AWSが提供するDNSリゾルバーのIPアドレスです。VPC内のインスタンスがDNSクエリを行う際に使用します。独自のカスタムDNS設定を行わない限り、このアドレスがデフォルトでDNSリゾルバーとして機能します。
  - 将来の用途のために予約されたアドレス (4番目のIPアドレス)
    - 役割: 現時点で特定の用途が明確には指定されていませんが、AWSが今後の機能拡張や内部用途のために予約しています。
  - ブロードキャストアドレス (最後のIPアドレス)
      - 例: 10.0.0.255/24サブネットの場合、10.0.0.255がこのアドレスです。
      - 役割: ブロードキャスト通信のために予約されていますが、AWSのVPCではブロードキャスト通信はサポートされていないため、実際に使用することはありません。

### セキュリティグループ・ネットワークACL・AWS Network Firewall

- AWS Network Firewallは有料なのであまり使われない
- セキュリティグループ(SG)→ネットワークACLと、フィルタの範囲を狭めて、シンプルな構成・運用にする
- SGは、同一SGに所属しているノード同士の通信でも明示的に許可する必要がある

### ルートテーブル

- ルートテーブルは複数のサブネットで共有可能
- サブネット作成時にルートテーブルも作成され、追加の設定なくVPC内の通信は可能

### VPCエンドポイント

- 異なるVPCやリージョンに配置されたAWSサービスへインターネットを経由せずに接続するサービス
- ゲートウェイエンドポイント
  - ルートテーブルでAWSサービスへのルートを指定
  - 費用かからない
- インターフェイスエンドポイント
  - VPCのプライベートIPアドレスを使用してアクセスする
  - ENIとしてVPC内に配置され、それがサービスに接続するためのエンドポイントとして動作する
  - 処理するデータ量に応じて課金される
- 例えばS3は、どちらでも接続可能だが、インターフェイスエンドポイントの方がセキュリティグループでトラフィックを制御できるため、セキュアである
  - VPC内のリソースがエンドポイントに対して、どのように通信できるかを詳細に制御ができるため、という意味(IPやプロトコル等の制限が可能)

### VPCフローログ

- VPC内のネットワークインターフェースに流れる情報をキャプチャし、ログに記録する
- 監査に必要なログを出力したり、通信がうまく通らない場合はトラブルシューティングとして出力したり
- フローログは以下の3つの項目を指定する
  1. フローログを取得するリソース(VPC/サブネット/ENIをもつELBやNATGateway等)
  2. どんなトラフィックをキャプチャするか(許可、拒否、全て)
  3. フローログの出力先(CloudWatch Logs/S3)