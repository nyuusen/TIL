# AWS運用入門

[AWS運用入門 | SBクリエイティブ](https://www.sbcr.jp/product/4815615499/)

# Chapter9 セキュリティ統制

## WAF

- SGでは4層のトランスポート層レベルの脅威から守ることができるが、通信内容(パケット)まではチェックすることはできない
  - 例にすると、監視カメラで宅配業者を通過させることができるが、荷物の中身までは見えない
- WAFでは、CloudFront, ALB, API Gateway, AppSyncにWeb Access Control List(Web ACL)を関連づけることで動作する
  - Web ACLとは、WAFが通信内容を検査する際に適用するルールのことで、1つのWeb ACLに複数の検査ルールを定義することが可能
  - 1つのAWSリソースに対して、1つのWeb ACLのみ関連づけが可能である
- Web ACLで定義するルールは、JSON形式のStatementとして、そのStatementに「合致あるいは不一致の場合に検査した通信を許可するのか拒否するのか」をActionとして定義する
  - ルールで定義する条件には、IPアドレス・HTTPヘッダー・HTTP本文・URL文字列・SQLインジェクション・XSSがある
  - 定義可能なルールとして、AWSが提供するマネージドルールとユーザーが独自に作成可能なカスタムルールの2つがある
- 適用可能なルール数はAWS WAF Web ACL capacity units(WCU)によって制限される
  - WCUは、検査にかかるコストを表現したもので、5000WCUsが上限である

## サーバー側の暗号化

- 電子データにおける暗号化には「通信の暗号化」と「データの暗号化」がある
- 変換方法を「アルゴリズム」、変換ルールを「キー（鍵）」という
  - 例：シーザー暗号（アルファベットを辞書順に3文字ずらして暗号文を作る」
    - この時の「アルファベットを辞書順にずらす」というのをアルゴリズム、「3文字」がキーとなる
- 現在普及しているアルゴリズムは仕様が全て公開されている（外部の専門家から弱点を指摘してもらい、より強固なアルゴリズムを構築するため）
- なので、暗号化においては「キーの取り扱い」がセキュリティを担保する上で重要となる
  - 「アルゴリズム」は公開されているので、「キー」の方を大事に取り扱いましょうという話

### AWS KMS

- KMSは、データ保護に使用される暗号鍵の作成・管理・運用基盤を提供するサービス
- 保管データの暗号化だけでなく、「キー」自体も暗号化することでセキュリティを高めている
- 保管データを暗号化する暗号鍵をCustomer Data Key(CDK)、CDKを暗号化するための暗号鍵をCustomer Master Key(CMK)
  - 暗号化時にKMSはCDKを都度生成するので、ユーザー側ではCDKは管理することができない
  - よってユーザーはCMKの作成・管理・運用を行うことになる
- CMKの運用・管理を「ライフサイクル」と「アクセス」という2つの観点から考える

#### CMKのライフサイクル管理

- キーローテーションと削除スケジュールの2つがある
- 1年に1回、自動でローテーションされる
- ローテーションの前後で作成されたCMKは世代管理されている
  - 注意点として、削除されたCMKで暗号化されたデータは復号できなくなる
- そこで登場するのが削除スケジュールであり、削除までの一定の期間を待機状態とさせることができる

#### CMKのアクセス管理

- 誰がどのような権限で利用できるかをキーポリシーで定義する
- キーポリシーは「リソースベースポリシー」に該当するため、IAMポリシーよりも優先度が高い
- Principalには街頭のリソースへのアクセスを許可・拒否するエンティティを指定する
  - 誰が・どのような人がにあたる部分で、AWSアカウント全体、IAMユーザーやロールを指定する、特定のサービス（Lambdaとか）が指定可能
