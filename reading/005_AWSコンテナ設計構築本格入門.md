# AWSコンテナ設計構築本格入門

[AWSコンテナ設計構築本格入門](https://www.nri-net.com/books/2fxup8utd3sl/)
[いまならこう作りたい AWSコンテナ[本格]入門ハンズオン　〜2024年版 ハンズオンの構想〜 - Speaker Deck](https://speakerdeck.com/horsewin/imanarakouzuo-ritai-awskontena-ben-ge-ru-men-hanzuon-2024nian-ban-hanzuonnogou-xiang)

# Chapter01 コンテナの概要

- コンテナは、他のプロセスとは隔離された状態でOS上にソフトウェアを実行する技術
  - コンテナ上で実行されたソフトウェアは単に1つのプロセスとして稼働しているのにも関わらず、**コンテナ内のソフトウェアから見ると独立したOS環境を占有している**ように見える
- サーバー仮想化は、ゲストOSごとにカーネルを占有する仕組み
- コンテナ技術は、OSとカーネルは共有し、プロセスを分離する仕組み
  - コンテナのプロセスごとに、プロセッサやメモリ等のコンピューティングリソースが割り当てられ、アプリケーション稼働に必要なライブラリやミドルウェア等の依存関係が全て含まれる

# Chapter02 コンテナの設計に必要なAWSの基礎知識

- コントロールプレーン
  - コンテナを管理する機能
  - ECSがこれにあたり、ECSはフルマネージドなコンテナオーケストレーターである(実行環境ではない)
- データプレーン
  - 実際に稼働するリソース環境
  - EC2とFargateがある

# Chapter03 コンテナを利用したAWSアーキテクチャ

- Well-Architectedフレームワークに則り、アーキテクチャを考える

## 1. 運用上の優秀性

- 以下のような観点から設計を検討する
  - どのようにシステムの状態を把握するか
  - どのように不具合の修正を容易にするか
  - どのようにデプロイのリスクを軽減するか
- モニタリングとは？
  - システム内で定めた状態を確認し続けること
  - 目的は、システムの可用性を維持するために問題発生に気づくことである
- →メモリ使用量などの定量情報である「メトリクス」や、アプリケーションの「ログ」などの定性的な情報から状態を検知し、アラートとして通知する
- ECSのようなコンテナサービスでは、小さなサービス同士が連携して動作することが多いので、障害発生時の影響範囲の把握や原因の特定が難しくなりがち
  - そこで、一連の処理内容を追えるためにするのが「トレース」
- 上記をひっくるめて、システム内部の状態を深掘りできるような状態を「オブザーバビリティ」という
  - オブザーバビリティを獲得することが、優れた運用に繋がる

### ロギング設計

- CloudWatch Logsによるログ運用
  - ECS/Fargate構成では、CloudWatch Logsと連携することで、容易にログを収集できる
    - 具体的には、タスク定義のlogConfiguration.logDriverにawslogsを設定するだけ
  - サブスクリプションフィルターを使って特定の文字列が含まれている場合のみLambdaに連携→SNSを使って通知
- FireLensによるログ運用
  - メリットは、CloudWatch Logs以外のAWSサービスやAWS外のSaaSへのログ転送がしやすい
  - ログルーティング機能を担うOSSのFluentBitなどの選択が可能
  - CloudWatch Logsへの同時転送も可能
- CloudWatch LogsとFireLensの使い分け
  - ECSタスク定義の仕様としては、コンテナごとにログ出力先を指定するログドライバーの定義は1つ
  - まず考えられるのがCloudWatch Logsを転送→S3にエクスポートする
    - CloudWatch Logsはログを取り込んだタイミングで料金が発生してしまう
  - コスト最適化と障害時運用の両立を図りたい場合は、FireLensがオススメ
    - FluentBitは、CloudWatch LogsとS3への同時ログ転送に対応している
  - 一方で、CloudWatch Logsに取り込まれたログは、クエリベースでログ検索できたり、ダッシュボード表示が可能と、一概にCloudWatch Logsへの転送を避けるべきではない
  - ログ運用で大事なのは**「ビジネス観点で、ログをどのように扱うか、ユースケースを描くこと」**である
    - ビジネス目標に対して、ログ種類や保持期間、分析方法を検討し、設計する

### メトリクス設計

- ECSで取得可能なメトリクスとして、以下が挙げられる
  - CloudWatchメトリクス
  - CloudWatch Container Insights
- 以下は、ECSクラスターまたはECSサービスの単位でデフォルトで取得できる
  - CPU使用率
  - メモリ使用率
    - それぞれ1分間隔で取得
- より詳細なメトリクスを取得するにはCloudWatch Container Insightsの有効化が必要
  - ECSタスクごとに収集可能
  - ディスクやネットワークに関するメトリクス

### トレース設計

-  trace情報の取得をサポートするサービスとして「X-Ray」がある
   - サービスマップのダッシュボードも提供されており、システム全体の可視化も可能
- ECS/FargateでX-Rayを利用する場合、以下のようなサイドカー構成となる
  - ECSタスク定義の中にアプリケーションコンテナとX-Rayコンテナを同梱する
  - アプリケーション自体にAWSが提供するX-Ray用のSDKで一部コーディングを施す
- ECS上のコンテナアプリケーションからX-Rayにトレース情報を書き込むためには特定のIAM権限が必要となる
  - 具体的には、ECSタスクロールが必要になる
  - タスク実行ロールではないことは注意（X-Rayにトレース情報を書き込む主体はECSコンテナエージェントではなく、ECSタスク＝X-Rayコンテナなので）
- VPCからパブリックネットワークへの通信経路が必要
  - X-RayはVPC外のAWSパブリックネットワーク上に存在する
  - ECSタスクがプライベートサブネットにデプロイされている場合は、X-Ray用のVPCエンドポイントかNATゲートウェイを用意する

# Chapter04 コンテナを構築する(基礎編)
# Chapter05 コンテナを構築する(実践編)

