# AWSで始めるインフラ構築入門

## 4.VPC

### 基本

- VPC内には1つ以上のサブネットを構成する
  - サブネットはプライベート/パブリックがある
- AZごとにサブネットを構成すると、可用性が向上する
  - VPC(AZ1(PublicSubnet&PrivateSubnet)AZ2(PublicSubnet&PrivateSubnet))みたいな構成
- VPCは、AZを跨げるが、リージョンはまたげない
  - ある1リージョンの中で論理的な仮想ネットワーク

### IPv4 CIDRの設計方法

- サブネットを一度作成すると、サブネットが利用するCIDRブロックは変更不可
- CIDR設計する際に、以下の2点をまずは考える必要がある
  1. 作成するサブネット数
  2. サブネット内に作成するリソース数
  - これらはトレードオフの関係にあり、サブネットの数を増やすと、サブネット内のリソース数は減る
  - 例えば、10.0.0.0/16というCIDRブロックを持つVPCを仮定する
    - /16なので、第3・4オクテッド(16ビット分)がホスト部になる
  - 16ビットの中で、サブネットとリソースを割り当てることになる
    - サブネット8ビット(256)とした場合は、リソースも8ビット(256-5=251)となる
    - ※リソース数は理論的な最大値から5つを引いた数になる
  - 書籍では/20で設定しており、/20だと4091個のリソースを作成できるので十分
    - 実務でもこのくらいで割り当てるのが良いのかなと思った
    - 追記: いくつか記事を読むとVPCには/16、サブネットには/24を割り当てるケースが多そう
- まとめると、**まずVPCのCIDRブロックを決定した後に、その範囲の中でサブネットのCIDRブロックを決定する**

### インターネットゲートウェイ

- VPCで作成されたネットワークとインターネット間を通信を可能にするためのもの
- **VPCに存在する(サブネットではない)**
- IGW作成した後にVPCにアタッチする必要がある

### NATゲートウェイ

- 前提として、
  - IGWはVPCとインターネットが通信可能にするためのもの
  - インターネットとの通信にはパブリックIPを持っている必要がある
  - 「パブリックIPを持つ＝インターネットに公開されている」であるため、プライベートサブネットで外部通信をどのように実現するかという話になる
- 上記を解決するものとして、NATゲートウェイがある
  - NATゲートウェイは、パブリックサブネットに配置し、プライベートサブネット内のリソースを外部に通信できるようにする
- プライベートサブネットにあるリソース→NATゲートウェイ→インターネットゲートウェイという順で外部に通信を行う
  - この通信制御は、ルートテーブルで行う

### NATの仕組み

- アパートを例にすると、アパートの中では部屋番号のみで特定できるが、アパートの外と郵便物をやり取りする場合は、住所＋部屋番号が必要になる
- これをNATの仕組みに割り当てると、NATゲートウェイにパブリックIPを割り当て(住所)、内部ではプライベートIP(部屋番号)で判別する仕組み
- この時の送信元IPは、パブリックIP＋プライベートIPになるのか？どのように特定するのか？
  - 外部から見た時の送信元IPは、パブリックIPになる
  - 内部的には、プライベートIP＋ポート番号とパブリックIP＋ポート番号のペアを一時的に保存し、特定している

### NATゲートウェイの構築

- NATゲートウェイを配置するサブネットを設定する
  - ここはインターネットと通信する場合はパブリックなサブネットを指定する必要がある
  - むしろプライベートなサブネットを指定することってあるの？と思った(調べてもそのような使い方は見つからず...)
- ElasticIP割り当てIDを指定する(自動生成)
  - これが外部と通信するときに、外部から見えるIPアドレスになるのだと思われる

### 補足: ElasticIP

- AWSでは、リソースにIPアドレスを直接持たせることができない(そうなんだ...)
- パブリックIPを管理するElasticIPをリソースに割り当てることで、リソースに**間接的に**パブリックIPを割り当てることができている

### ルートテーブル

- サブネット同士やサブネットと各ゲートウェイの間の通信経路を定義するためにルートテーブルが必要になる
  - これがないとサブネット内からサブネット外に通信を行うことができない
  - 具体的には「ネットワークトラフィックがどの宛先に対してどの経路を通るかを決定するための設定」を定義する
  - もっと具体的には「トラフィックが、インターネットや他のVPC、プライベートネットワーク内のリソースにどのように到達するか」を定義する
- ルートテーブルはサブネットごとに存在する
- 一般的な設定例
  - 例1: パブリックサブネット用のルートテーブル
    - 送信先: 0.0.0.0/0 -> ターゲット: インターネットゲートウェイ (igw-xxxxxxx)
      - 意味: インターネット通信
  - 例2: プライベートサブネット用のルートテーブル
    - 送信先: 0.0.0.0/0 -> ターゲット: NATゲートウェイ (nat-xxxxxxx)
  - 例3: 同一VPC内のリソース
    - 送信先: 10.0.0.0/16 -> ターゲット: Local
  - 送信先: どこに接続するかをIPアドレス(特定のIPでもCIDR形式でも可)
  - ターゲット: どこを経由するか
    - 指定できる値は決まっている(ローカル/IGW/NAT GW/VPN GW/VPCピアリング/VPCエンドポイント)

#### 余談: 0.0.0.0/0とは？

- すべてのIPv4アドレスの範囲をCIDR表記
- インターネット上の全てのアドレスが対象となる
- ルートテーブルには大抵複数のルートが定義され、どれにも当てはまらかったルートは0.0.0.0/0として扱われるのだと思われる

#### 余談: ルートテーブルに複数ルートが定義されている時の優先順位は？

- 宛先CIDR範囲の具体性に基づいて決まる
- より具体性の高い(範囲が狭い＝詳細な)ルートが適用される

### セキュリティグループ

- 外部からのアクセス制限を設けるために使用する
- 外部からのアクセスを以下2つの要素で制御ができる
  - ポート番号
  - IPアドレス

### セキュリティグループの作成

- セキュリティグループ作成時にVPCを指定する必要がある
  - VPCを跨いで同じセキュリティグループを使用することは不可
    - この理由を推察すると以下のような理由が考えられる(私の持論)
      - セキュリティグループはVPC内リソースに対する通信を制御するため、VPC内の他のリソースを指定する。
      - つまり、他のVPCのリソースを参照したり、プライベートIPの重複考慮したりすると、VPCを跨いで同じセキュリティグループを設定することは事実不可である(多分)

#### 余談: ネットワークACLとの違い

- 設定範囲が異なる
  - セキュリティグループ: リソース
  - ネットワークACL: サブネット
- 2段構えで設定することにより、設定漏れを防ぐことができる
- 一方で、アクセス制御を2箇所で管理することになるので運用コストが増える
  - 筆者は、セキュリティグループのみ設定しているらしい

## 7.ロードバランサー

- LBでTLS復号を行うことでWebサーバーの負荷を軽減できる
  - クライアントからLBはHTTPS通信・LBとWebサーバー間はHTTP通信
- LBで80(HTTP)or443(HTTPS)ポートを公開するが、内側のWebサーバーは必ずしも同ポートに設定を合わせる必要はない
  - これをやるメリットとしてはWebサーバーのセキュリティ向上が挙げられる
  - 具体的にはLinuxOSでは0~1023番ポートで待ち受けするためには、強力な権限(root権限)を持ったユーザーでプログラムを動作させる必要がある
    - そのプログラムが悪意あるユーザーに乗っ取られてしまった場合、強力な権限が悪意あるユーザーに渡ってしまう
    - どの番号が使用されるかは慣習により、Java言語をベースとしたものは8080、Ruby言語をベースとしたものは3000(Node.jsも3000が多い)が使われることが多い

## 8.RDS

- RDSは以下の4つで構成される
  - データベースエンジン
    - DB本体
  - パラメータグループ
    - DBエンジン固有の設定
    - 使用する言語やDBのチューニングの設定
    - **データベースエンジンそのものの基本動作やパフォーマンスを制御するための設定**
  - オプショングループ
    - RDS固有の設定
    - AWSによるDB監視設定とか
    - **データベースエンジンにプラグインや追加機能を付加するための設定**
  - サブネットグループ
    - DBサーバーを複数のAZに分散させて配置する時に使用する

### データベースサーバー構築

- 以下の流れで作成する
  1. パラメータグループ作成
  2. オプショングループ作成
  3. サブネットグループ作成
  4. データベース作成

#### 1.パラメータグループ作成

- パラメータグループファミリー: mysql8.0等
- タイプ: 通常のRDS用かクラスタリングRDS用か

#### 2. オプショングループ作成

- エンジン: mysql
- メジャーエンジンバージョン: 8.0

#### 3. サブネットグループ作成

- RDSを作成する時はサブネットグループを指定し、どのサブネットに作成されるかはAWSに任せることになる
  - 理由: RDSはマネージドサービスとして、耐障害性や自動フェイルオーバーなどを考慮して配置を決定するため(AWS側で最適な配置が自動的に行われる仕組みになっている)

#### 4. データベース作成

- エンジンのタイプ
- マスターユーザー名やパスワード
- DBインスタンスクラス
- 上で設定した各グループ識別子を指定する

## 9.S3

- S3は、OS・スケーリング・監視の部分を運用側が意識せずにデータ管理のみに集中できる
- S3にアクセスするリソースに対しては、それを許可するIAMロールを割り当てる必要がある

## 10.Route53

- ホストゾーンを作成する時に「プライベート」を選択することができる
  - プライベートDNSで登録するドメインは、パブリックも含めてユニークにする必要がある
    - 理由: 名前解決する時に意図しないリソースへのアクセスが行われてしまう可能性があるため
- RDSには固定されたIPアドレスが参照できなくなっている代わりに、エンドポイントが用意されている
  - そのエンドポイントを値に持つCNAMEレコードを登録することで、ドメインの名前解決ができるようになる

## 11.メールサーバー

### メールが届く仕組み

- 送信者が自分が所属する組織のメールサーバーに送信を依頼する
- 受信者側のメールサーバーにメールが届く
- 受信者が自身のメールサーバーのメールを閲覧する
- 補足
  - 送信にはSMTPプロトコルが使用され、受信にはPOP3・IMAP4が使用される

### 補足: HTTPでメール送れるようにすれば良いのでは？なぜSMTP？

- SMTPにはメール通信に必要不可欠な以下の機能(特長)を有している
  - リトライ機能(HTTPのリトライはクライアント依存)
  - 多段階転送 クライアント→メールサーバー→受信サーバー(HTTPはクライアント→サーバー)
  - メールの特殊なデータ構造 ファイル添付や複雑なヘッダー情報
- 設計思想的に、HTTPは即時性みたいなものが重視され、SMTPは信頼性が重視されている

### SES(Amazon Simple Email Service)

- メールの送受信を行う機能を提供するマネージドサービス
- 通常のメールサーバーとは異なり、人ではなくアプリからメールを送受信を行うのに都合が良い機能が用意されている
- 送信
  - システム(ex:no-reply@example.com)からメールを送る場合、そのユーザーをIAMユーザーとして登録し、IAMユーザーを使って、メール送信ができる
- 受信
  - POP3やIMAP4は使用しない(通常のメール受信と大きく異なる)
  - 代わりにメールを受信した時にアクションと呼ばれる処理が実行される
    - S3に保存する、SNSトピックに公開する、Lambda関数を実行する等
    - SNSアクションに登録しておくと、管理者のメールや携帯にプッシュ通知を送ることができる
  - つまり、ユーザーからのメールを管理者が手動で対応する運用が行えないということになる
    - 代わりに用意されているアクションの機能を考慮すると、CRMシステムとの連携を想定している
    - その辺りを考慮して、SESを使うのか他のメールサーバーを使うのかを考える必要がある

## 12.キャッシュサーバー

- RedisとMemcachedというOSS(ミドルウェア)がある
- これをEC2で作成したLinuxサーバーにインストールしてサーバーとして動作させることが可能
  - ただこれは運用やコスト面で課題がある
- Redis/Memcachedと互換性のあるElastiCacheというマネージドサービスがある

### ElastiCache

- 基本的にはあるキーに対してキャッシュされたデータを返す、キーバリュー型の仕組みを提供する
- ElastiCacheは以下の階層構造を持つ
  - ノード: 最小単位。実際のデータが保存される。
  - シャード: ノードを束ねるグループ。1つのプライマリノードと複数のレプリカノードで構成される。
    - プライマリノードに障害が発生したら、レプリカノードで処理継続できるので、耐障害性が上がる
  - クラスター: シャードを束ねるグループ。複数のシャードで構成される。
    - マルチAZ構成にできる。フェイルオーバーで耐障害性アップ。
- redis-cliで、クラスターのエンドポイント向けに動作確認を行うことができる
