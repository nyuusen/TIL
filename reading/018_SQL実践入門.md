# SQL実践入門

## 1章 DBMSのアーキテクチャ

- エンジニアとして特に押さえておくべきは「クエリ評価エンジン(実行計画)」で次点で大事なのが「バッファマネージャー」
- バッファ
  - メモリからデータを取った方が当然速い
  - バッファは緩衝材という意味で、この文脈ではユーザーとストレージの間に入って、ディスク減らす役割を果たす
  - このバッファにどれくらい何を入れておくかを管理するのが、バッファマネージャー
- キャッシュはユーザーとストレージの中間に位置することでデータの転送緩和する
- キャッシュもバッファも、物理的な場所としてメモリなのは同じ
- 2つのバッファ: データキャッシュとログバッファ
  - 更新SQLを受け取ったら、まずはログバッファに更新情報を溜めている
  - コミット時にディスクに反映する
  - わざわざこんなことをするのは、更新にも多大な時間がかかるので、パフォーマンスを良くするため
- ここまでのバッファの説明で、結局DBMSはストレージの遅さをどうカバーするかということをずっと考えてきた
- バッファ(メモリ)の揮発性の問題点は、コミットのタイミングで必ず更新情報を永続ストレージ上にあるログファイルを書き込むことで解決
- 各DBMSのログバッファのサイズが小さい理由は、データベースは検索を想定しているため。データキャッシュに割くようにしている。
  - もし更新量が多い業務の場合はログバッファのサイズを大きくするチューニングを行う
- 2つのバッファ以外ではワーキングメモリというメモリ領域がある
  - ソートやハッシュなど特定の処理に利用される作業用領域
  - ワーキングメモリが溢れるとTEMP落ち(ストレージ領域なので遅い)
  - メモリ不足だと落ちるわけではなく、何とかして処理継続しようとするのがDBMS
- データアクセスの手続きを決めるモジュールはクエリ評価エンジン
  - パーサー：構文解析
  - オプティマイザ：実行計画の決定。最適化。最もコストが低い計画を絞り込む。
  - カタログマネージャ：内部情報を保持。テーブルやインデックスなどの統計情報。
  - プラン計画：オプティマイザが組み立てた複数の実行計画から最適な実行計画を選択。
- ポイントはオプティマイザをうまく使ってあげる
  - 統計情報が不適切だと最適なプランは選択されない
  - 統計情報更新は手動でも可能
- SQLで遅延が発生したら
  - まずは実行計画を確認する