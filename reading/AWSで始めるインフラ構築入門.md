# AWSで始めるインフラ構築入門

## 4.VPC

### 基本

- VPC内には1つ以上のサブネットを構成する
  - サブネットはプライベート/パブリックがある
- AZごとにサブネットを構成すると、可用性が向上する
  - VPC(AZ1(PublicSubnet&PrivateSubnet)AZ2(PublicSubnet&PrivateSubnet))みたいな構成

### IPv4　CIDRの設計方法

- サブネットを一度作成すると、サブネットが利用するCIDRブロックは変更不可
- CIDR設計する際に、以下の2点をまずは考える必要がある
  1. 作成するサブネット数
  2. サブネット内に作成するリソース数
  - これらはトレードオフの関係にあり、サブネットの数を増やすと、サブネット内のリソース数は減る
  - 例えば、10.0.0.0/16というCIDRブロックを持つVPCを仮定する
    - /16なので、第3・4オクテッド(16ビット分)がホスト部になる
  - 16ビットの中で、サブネットとリソースを割り当てることになる
    - サブネット8ビット(256)とした場合は、リソースも8ビット(256-5=251)となる
    - ※リソース数は理論的な最大値から5つを引いた数になる
  - 書籍では/20で設定しており、/20だと4091個のリソースを作成できるので十分
    - 実務でもこのくらいで割り当てるのが良いのかなと思った
- まとめると、まずVPCのCIDRブロックを決定した後に、その範囲の中でサブネットのCIDRブロックを決定する

### インターネットゲートウェイ

- VPCで作成されたネットワークとインターネット間を通信を可能にするためのもの
- **VPCに存在する(サブネットではない)**
- IGW作成した後にVPCにアタッチする必要がある

### NATゲートウェイ

- 前提として、
  - IGWはVPCとインターネットが通信可能にするためのもの
  - インターネットとの通信にはパブリックIPを持っている必要がある
  - 「パブリックIPを持つ＝インターネットに公開されている」であるため、プライベートサブネットでどのように実現するかという話になる
- 上記を解決するものとして、NATゲートウェイがある
  - NATゲートウェイは、パブリックサブネットに配置し、プライベートサブネット内のリソースを外部に通信できるようにする
- プライベートサブネットにあるリソース→NATゲートウェイ→インターネットゲートウェイという順で外部に通信を行う


### NATの仕組み

- アパートを例にすると、アパートの中では部屋番号のみで特定できるが、アパートの外と郵便物をやり取りする場合は、住所＋部屋番号が必要になる
- これをNATの仕組みに割り当てると、NATゲートウェイにパブリックIPを割り当て(住所)、内部ではプライベートIP(部屋番号)で判別する仕組み
- この時の送信元IPは、パブリックIP＋プライベートIPになるのか？どのように特定するのか？
  - 外部から見た時の送信元IPは、パブリックIPになる
  - 内部的には、プライベートIP＋ポート番号とパブリックIP＋ポート番号のペアを一時的に保存し、特定している

### NATゲートウェイの構築

- NATゲートウェイを配置するサブネットを設定する
  - ここはインターネットと通信する場合はパブリックなサブネットを指定する必要がある
  - むしろプライベートなサブネットを指定することってあるの？と思った(調べてもそのような使い方は見つからず...)
- ElasticIP割り当てIDを指定する(自動生成)
  - これが外部と通信するときに、外部から見えるIPアドレスになるのだと思われる

### 補足: ElasticIP

- AWSでは、リソースにIPアドレスを直接持たせることができない(そうなんだ...)
- パブリックIPを管理するElasticIPをリソースに割り当てることで、リソースに**間接的に**パブリックIPを割り当てることができている

### ルートテーブル

- サブネット同士やサブネットと各ゲートウェイの間の通信経路を定義するためにルートテーブルが必要になる
  - これがないとサブネット内からサブネット外に通信を行うことができない
  - 具体的には「このサーバーに接続するときには、ここを経由する」といった内容を定義する