# AWSで始めるインフラ構築入門

## 4.VPC

### 基本

- VPC内には1つ以上のサブネットを構成する
  - サブネットはプライベート/パブリックがある
- AZごとにサブネットを構成すると、可用性が向上する
  - VPC(AZ1(PublicSubnet&PrivateSubnet)AZ2(PublicSubnet&PrivateSubnet))みたいな構成

### IPv4　CIDRの設計方法

- サブネットを一度作成すると、サブネットが利用するCIDRブロックは変更不可
- CIDR設計する際に、以下の2点をまずは考える必要がある
  1. 作成するサブネット数
  2. サブネット内に作成するリソース数
  - これらはトレードオフの関係にあり、サブネットの数を増やすと、サブネット内のリソース数は減る
  - 例えば、10.0.0.0/16というCIDRブロックを持つVPCを仮定する
    - /16なので、第3・4オクテッド(16ビット分)がホスト部になる
  - 16ビットの中で、サブネットとリソースを割り当てることになる
    - サブネット8ビット(256)とした場合は、リソースも8ビット(256-5=251)となる
    - ※リソース数は理論的な最大値から5つを引いた数になる
  - 書籍では/20で設定しており、/20だと4091個のリソースを作成できるので十分
    - 実務でもこのくらいで割り当てるのが良いのかなと思った
- まとめると、**まずVPCのCIDRブロックを決定した後に、その範囲の中でサブネットのCIDRブロックを決定する**

### インターネットゲートウェイ

- VPCで作成されたネットワークとインターネット間を通信を可能にするためのもの
- **VPCに存在する(サブネットではない)**
- IGW作成した後にVPCにアタッチする必要がある

### NATゲートウェイ

- 前提として、
  - IGWはVPCとインターネットが通信可能にするためのもの
  - インターネットとの通信にはパブリックIPを持っている必要がある
  - 「パブリックIPを持つ＝インターネットに公開されている」であるため、プライベートサブネットでどのように実現するかという話になる
- 上記を解決するものとして、NATゲートウェイがある
  - NATゲートウェイは、パブリックサブネットに配置し、プライベートサブネット内のリソースを外部に通信できるようにする
- プライベートサブネットにあるリソース→NATゲートウェイ→インターネットゲートウェイという順で外部に通信を行う


### NATの仕組み

- アパートを例にすると、アパートの中では部屋番号のみで特定できるが、アパートの外と郵便物をやり取りする場合は、住所＋部屋番号が必要になる
- これをNATの仕組みに割り当てると、NATゲートウェイにパブリックIPを割り当て(住所)、内部ではプライベートIP(部屋番号)で判別する仕組み
- この時の送信元IPは、パブリックIP＋プライベートIPになるのか？どのように特定するのか？
  - 外部から見た時の送信元IPは、パブリックIPになる
  - 内部的には、プライベートIP＋ポート番号とパブリックIP＋ポート番号のペアを一時的に保存し、特定している

### NATゲートウェイの構築

- NATゲートウェイを配置するサブネットを設定する
  - ここはインターネットと通信する場合はパブリックなサブネットを指定する必要がある
  - むしろプライベートなサブネットを指定することってあるの？と思った(調べてもそのような使い方は見つからず...)
- ElasticIP割り当てIDを指定する(自動生成)
  - これが外部と通信するときに、外部から見えるIPアドレスになるのだと思われる

### 補足: ElasticIP

- AWSでは、リソースにIPアドレスを直接持たせることができない(そうなんだ...)
- パブリックIPを管理するElasticIPをリソースに割り当てることで、リソースに**間接的に**パブリックIPを割り当てることができている

### ルートテーブル

- サブネット同士やサブネットと各ゲートウェイの間の通信経路を定義するためにルートテーブルが必要になる
  - これがないとサブネット内からサブネット外に通信を行うことができない
  - 具体的には「ネットワークトラフィックがどの宛先に対してどの経路を通るかを決定するための設定」を定義する
  - もっと具体的には「トラフィックが、インターネットや他のVPC、プライベートネットワーク内のリソースにどのように到達するか」を定義する
- ルートテーブルはサブネットごとに存在する
- 一般的な設定例 
  - 例1: パブリックサブネット用のルートテーブル
    - 送信先: 0.0.0.0/0 -> ターゲット: インターネットゲートウェイ (igw-xxxxxxx)
      - 意味: インターネット通信
  - 例2: プライベートサブネット用のルートテーブル
    - 送信先: 0.0.0.0/0 -> ターゲット: NATゲートウェイ (nat-xxxxxxx)
  - 例3: 同一VPC内のリソース
    - 送信先: 10.0.0.0/16 -> ターゲット: Local
  - 送信先: どこに接続するかをIPアドレス(特定のIPでもCIDR形式でも可)
  - ターゲット: どこを経由するか
    - 指定できる値は決まっている(ローカル/IGW/NAT GW/VPN GW/VPCピアリング/VPCエンドポイント)

#### 余談: 0.0.0.0/0とは？

- すべてのIPv4アドレスの範囲をCIDR表記
- インターネット上の全てのアドレスが対象となる
- ルートテーブルには大抵複数のルートが定義され、どれにも当てはまらかったルートは0.0.0.0/0として扱われるのだと思われる

#### 余談: ルートテーブルに複数ルートが定義されている時の優先順位は？

- 宛先CIDR範囲の具体性に基づいて決まる
- より具体性の高い(範囲が狭い＝詳細な)ルートが適用される

### セキュリティグループ

- 外部からのアクセス制限を設けるために使用する
- 外部からのアクセスを以下2つの要素で制御ができる
  - ポート番号
  - IPアドレス

#### 余談: ネットワークACLとの違い

