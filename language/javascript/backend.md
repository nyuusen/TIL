# TS(JS)でのサーバーサイド開発

## はじめに

XでTSのバックエンド開発が向いてないよねという話題が盛り上がってたので、少し深掘りしてみる。

## 向いてないと思われている理由

- シングルスレッドで動作するから
- プロトタイプ汚染
- 数値計算や等価演算の挙動に怪しい箇所がある
- バッチ処理に向かない
- デプロイが割と面倒
- ライブラリの依存関係のあれでRAMが太る

### シングルスレッドで動作するから

- Nodeは1つのスレッドで全ての処理（リクエスト対応など）を処理する
  - CやJavaはリクエストごとにスレッドを作成して並列処理をする
  - Goでも同じで、リクエスト単位で
- Nodeは1つのメインスレッドを順番にタスク処理していくことで、シンプルで軽量な動作を実現している
- 具体的にはイベントループという仕組みで、非同期処理を効率的に捌いている
  - これは基本的には処理中は裏で待機、完了したら次の処理（コールバック）を実行していく
- これはリクエストごとに完全に独立した環境で処理するわけではない
  - あるリクエストに対する処理がメモリリークを起こした場合、同じプロセス内の他のリクエスト処理にも影響が発生するということ
  - 例えば画像変換や圧縮などのCPUを大量に使う処理が1件あると、それだけでメインスレッドが占有されて、他のリクエストが滞ってしまう

## 逆に向いているシーン

- I/Oバウンド処理（シンプルなAPI・DBアクセスが多いなど）が多い
  - I/Oの特性としてCPUが働く時間は少ないが、外部の応答を待っている時間が多いというのがある
  - イベントループは、その待ち時間に次の処理を進めることができる
  - 逆にマルチスレッド方式だと、スレッド数が限られている中で、I/O中は待機＝ブロッキング状態となる
  - I/O中にノンブロッキング状態で他の処理を進められるという点で優位性がある
