# write: broken pipeエラーを解決する

## 概要

個人開発しているアプリでDB接続時に以下のエラーが度々発生するので解決したい

```sh
write tcp [...]:51724->[...]:5432: write: broken pipe
```

※...という部分にはIPv6アドレスが入っている

個人開発しているアプリの技術スタックは以下の通り。

- バックエンド: Go(Cloud Run)
- データベース: Neon(Serverless Postgres)

## エラーを読み解く

まずエラーが発生している箇所をソースコードで追うと、DB処理の部分でエラーが吐かれている。

エラー内容で検索すると、TCPコネクションにデータを書き込もうとした際にネットワークエラーが発生するもので、broken pipeというのは、ネットワーク接続上でデータを送受信ができなかったことを意味するらしい。

エラーが発生する条件としては、以下の通り。

- 一度API内部のDB処理が成功した後
- 一定の時間が経過した後に再度DB処理が実行された時に当該エラーが発生する
  - サンプルが少ないため自信はないが、成功から次の実行まで5分以上空く時にエラーになってるっぽい

## 仮説を立てる

以上のことから、既に死んでいるコネクションを使用してDB接続を行い、エラーが出ているのではと仮説を立ててみる

## 調査

- Go(sqlパッケージ)
  - maxIdleTimeのデフォルト値はない＝無限に保持される
- DB(Neon)
  - デフォルトでは5分でインスタンスが0になるらしい
    - [参考](https://neon.tech/docs/connect/connection-latency#:~:text=By%20default%2C%20Neon%20scales%20a%20compute%20to%20zero%20after%205%20minutes%20of%20inactivity.)

## 調査結果を経て考察

恐らく仮説の通りで、5分経過するとDBインスタンスが落ちるが、アプリ側では既に消失しているDBインスタンスに対するコネクションを保持してしまっていた。\
そのコネクションを用いてDBにアクセスしようとした時に本ネットワークエラーが発生してしまったと思われる。

## 対応

https://github.com/nyuusen/ayoze/commit/25719057cfc4a140f8e422d1e7aa8938f0eae769 にて対応。\
アイドルコネクションの保持時間を4分(DBインスタンスが自動停止する5分より短い時間)に設定した。

サーバレスDBを使うとこの辺りも考慮しなければいけないんだなという学びがあった。
