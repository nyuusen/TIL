# DNS

## 名前解決の流れ

- クライアントがドメイン(example.com)へのアクセスを試行する
- クライアントが設定されたDNSリゾルバにドメイン名を問い合わせを行う
- DNSリゾルバがルートネームサーバ(.com)にネームサーバー(NS)情報を取得する
- DNSリゾルバがセカンドレベルドメイン(example.com)からIPアドレスを取得する
- DNSリゾルバがクライアントにIPアドレスを返す
- クライアントが名前解決されたドメインにアクセスする
- 参考: [新入社員「DNSってなんですか？」→ これ、どこまで答えられますか？？？？？？？？？](https://zenn.dev/msy/articles/e1e5aed46a3e49)

## ドメイン移管の流れ

業務でAWSアカウントを跨いだドメイン移管を行ったので、流れをまとめておく。  
AWSのRoute53を用いてドメイン管理を行なっているものとする。

- 移管先に対象ドメインのホストゾーンを作成(NSレコードが生成される)
- 親ドメインを管理しているホストゾーンの対象ドメインのNSレコードを更新する

### ハマったポイント

- 対象ドメインの向き先(Aレコード)はCloudFrontディストリビューション(CFD)であったが、代替ドメイン名(CNAMEs)はユニークである必要があった
  - そのため、旧アカウントと新アカウントのそれぞれのCFDの代替ドメイン名に今回のドメインを同時に設定しておくことができなかった
  - 以下の公式で紹介されている通り、ワイルドカードを使用する方法を採用したかったが、親ドメインの管理権限が自分たちになかったため、仕方なしに、旧の代替ドメイン名を一旦空にしてから、新の代替ドメイン名を設定するようにした。
    - [代替ドメイン名を別のディストリビューションに移動する - Amazon CloudFront](https://docs.aws.amazon.com/ja_jp/AmazonCloudFront/latest/DeveloperGuide/alternate-domain-names-move.html)
    - この方法では、一時的に証明書エラー(HTTPS接続エラー)が発生することに注意は必要
  - ちなみにこの代替ドメイン名は、ACM証明書の認証に使用されているらしい
