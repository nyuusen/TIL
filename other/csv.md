# CSV

- **C**omma **S**eparated **V**aluesの略
- **DSV（Delimiter-Separated Values）に含まれる1つで、他にもタブをデリミタとするTSVやセミコロンとするものもある**
  - データの中にタブを含むことは中々ないので、エスケープ処理を回避しやすくパースの計算コストを抑えられる
  - 欧州では小数点を,とすることもあるので、;にしたりする
- エンコーディング方式
  - UTF-8: ほぼこれで良い
    - BOMをつけるとExcelで開くときにこれはUTF-8でエンコーディングされていると解釈され文字化けしない
- 区切り文字: `,`
- 改行コード
  - Windowsは`CRLF`（`\r\n`）
  - Mac含むUnix系は`LF`
    - ユーザーにダウンロードさせるようなCSVの場合はWindowsの方が多いし、Windowsのは`CRLF` がベター
    - 逆にシステム間連携用のCSVなら`LF`が良さげ？
- ヘッダー有無
- エスケープ処理
  - `“`
    - 2連打ちの”がCSV的には一般的(`"He said ""Hello""”`のように`””`とすることで`”`を文字列として扱える)

## BOM（Byte Order Mark）

- BOMを理解するにはまずリトルエンディアンとビッグエンディアンを理解する

### リトルエンディアンとビッグエンディアン

- あるデータをメモリアドレスにどう配置するかというのがエンディアン
  - 例えば16進数で0x12345678という4バイト（32bit）のデータがあるときにおいて、
    - リトルエンディアン：`78 56 34 12`
      - 下位バイトを先頭に置く
      - x86 (Intel/AMD), ARM (Apple Silicon等)
    - ビッグエンディアン：`12 34 56 78`
      - 上位バイトを先頭に置く
      - ネットワークプロトコル (TCP/IP), 古いMac (PowerPC)
  - 厄介となるのがCPUによってメモリ上のマルチバイトデータの並び順という方言が異なるという点
- UTF-8では先頭のバイトを見れば「これは3バイトで1文字」というようなことがわかる仕組みのため、常に左から右に1バイトずつ連続したストリームとして処理できるので、エンディアン問題は発生しない
- それに対しUTF-16では、1文字を2バイトまたは4バイトという固定単位で取り扱うため、エンディアン問題が発生する

### BOMとは

- 本来のBOM
  - UTF-16において`0xFEFF`という「幅のない改行しないスペース（Zero Width No-Break Space）」という特殊な文字をファイルの先頭0バイト目に置き、読み手側が`0xFE 0xFF`ならBE、`0xFF 0xFE`ならLEとエンディアンを確定させるためのもの
- CSVの文脈におけるBOMは「このファイルはASCIIやShift_JISではなくてUTF-8です」という意味で、`0xEF 0xBB 0xBF`という3バイトの固定値をつけることで、Excelなどのファイルでファイルを開いた時に文字化けをしないようにするためのもの