# CORS

SOPというブラウザのセキュリティ制約を理解した上で、CORSをちゃんと理解する。

## Same Origin Policy(SOP)

- SOPとは、ブラウザにある仕組みのことで、あるオリジンから別のオリジンにあるリソースへのアクセスを制限するというもの
  - オリジン：`スキーム（プロトコル）`、`ホスト`、`ポート`の3つの組み合わせたもの(なので、いずれかがど異なるだけでも別オリジンと見なされる)
  - この仕組みが存在する理由は、例えば悪意あるスクリプトが仕込まれたWebページを読み込んだ時に、JSであらゆるリソースにアクセスできたらセキュリティ的な問題が生じうるので、それを防ぐため
- ここで制限の対象となるのは、JavaScriptからリクエストするもののみ（fetch()とか、scriptタグでのフォントインストールとか）
  - なので、HTMLのimgタグのsrc属性に別オリジンとなるURLが設定されていても、SOPによる制限は受けない
  - また、これはあくまでブラウザの機能なので、curlコマンドとかだとSOPの仕組みはない（CORSエラーは発生しない）

## Cross Origin Resource Sharing(CORS)

- CORSは、異なるオリジンからのリソース要求を可能にするブラウザの機能
  - この機能は、HTTPヘッダーを利用して実現される
- 実装的には、サーバーのレスポンスヘッダ`Access-Control-Allow-Origin`に許可したいリクエスト元のドメインを設定することで、そのドメイン(オリジン)からのリクエストを許可する仕組みとなっている
  - 例えば、APIサーバー側のレスポンスヘッダ`Access-Control-Allow-Origin`の値にフロントエンドドメインを設定することで、フロントエンドからのAPIサーバーへのアクセスが可能になる

補足として、よくCORSエラーと表現されることが多いが、あくまでCORS自体はクロスオリジンからのリクエストを許可するものである（CORSエラーというのは、SOPという制約を受けて＋CORSが設定されていないという内容のエラーである）

## CORSエラーが発生するタイミング

CORSエラーが発生するタイミングは、リクエストの種類によって異なる。

### 1.シンプルリクエストの場合

**シンプルリクエストとは？**

プリフライトリクエストが発生しないリクエストのことで、以下の条件に当てはまるもの。

- HTTPメソッドはGET、POST、HEADのいずれか
- リクエストヘッダーが以下のみ
  - Accept
  - Accept-Language
  - Content-Language
  - Content-Type（ただしapplication/x-www-form-urlencoded,multipart/form-data,text/plainのみ）
    - Authorizationやカスタムヘッダ(X-API-KEYなど)を含む場合は、非シンプルリクエストになる
- リクエストボディにBlobやArrayBufferなどを含まない（通常のテキストデータのみ）

簡単にまとめると「GETやHEADのサーバー側に影響を及ぼさない安全なメソッド」や「HTMLフォームで送信できる範囲のPOSTリクエスト」が該当する。

**CORSの検証〜エラー発生までの流れ**

- ブラウザがサーバーにリクエストを送信し＆サーバーからのレスポンスを受け取った後に`Access-Control-Allow-Origin`ヘッダーをみて、自身のOriginが含まれているかをチェックする
  - 自身のOriginが含まれていない場合、ブラウザがエラーを発生させ、レスポンスをJavaScript側に渡さない
  - 仮にサーバー側が200 OKを返してもいても、自身のOriginが含まれていなければエラーが発生する
  - `Access-Control-Allow-Origin`ヘッダー自体がそもそもない場合もエラーとなる
- シンプルリクエストは、基本的にはサーバー側に影響を及ぼさないリクエストなので、事後チェックとなっている
  - （なお、サーバー側に影響を及ぼす可能性がある）HTMLフォームから送信される範囲のPOSTリクエストが同じく事後チェックなのは互換性重視のため（HTMLフォームからのクロスオリジンリクエストはCORS登場の前から行われていた）

### 2.プリフライトリクエスト(が必要なリクエスト)の場合

- ブラウザがリクエスト送信前にOPTIONSメソッドでプリフライトリクエストを送る
  - ブラウザから、Access-Control-Request-Methodで実際に送るリクエストのメソッドをサーバー側に伝える
- サーバーがCORS関連の情報をブラウザに返却する
- ブラウザがレスポンスヘッダを見て、リクエストが許可されているかをチェックする
  - 許可されていれば、本リクエストを送信する
  - 許可されていなければ、本リクエストは送信されず、エラーが発生する

## 参考

- [オリジン間リソース共有 (CORS) - HTTP | MDN](https://developer.mozilla.org/ja/docs/Web/HTTP/CORS)
- [同一オリジンポリシー - ウェブセキュリティ | MDN](https://developer.mozilla.org/ja/docs/Web/Security/Same-origin_policy)
