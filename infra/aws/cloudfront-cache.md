# CloudFrontのキャッシュについて

## はじめに

新規システム構築時にキャッシュ戦略を考えたのでまとめる

## キャッシュする場所

`クライアント(ブラウザ) ---- CDN(CloudFront) ---- オリジンサーバー` という構成の場合、キャッシュする場所としては以下がある。

- ブラウザ
- CloudFront(CDN)
  ※オリジンサーバ側にも何らかのキャッシュ機構があるかもしれないが話が逸れるので割愛

## ブラウザキャッシュ

ブラウザキャッシュは、ブラウザのメモリやストレージにデータを保持する形でキャッシュを実現する。\
どのように、どのくらいキャッシュを行うかは、CloudFrontから返却される`Cache-Control`ヘッダの設定値による。

## CloudFrontキャッシュ

キャッシュポリシーで設定する。キャッシュポリシーはビヘイビアごとに設定が可能。\
ビヘイビアにはパスパターンで対象の拡張子やファイルパスを元に対象を特定し、キャッシュ以外にもリクエスト・レスポンス周りやオリジンの設定が可能。

キャッシュポリシーでは、オリジンからCache-Controlが返却された場合、どのように扱う(それを適用する/無視してCloudFrontの設定を使用する等)かも設定できる。\
キャッシュ保持時間を表すTTLには、min,default,maxの項目がある（これがちょっとややこしい..）

- min: オリジンからの指定有無に関係なく、CloudFrontがキャッシュする最小時間
- default: オリジンから指定がなかったらこの値が使用される
- max: オリジンの指定がこの値を超えていた場合に使用される、CloudFrontがキャッシュする最大時間

## CloudFrontを採用するメリット

- コンテンツの高速配信
  - 全国にあるエッジサーバーからコンテンツを返却できるので低遅延かつ高速なレスポンスが期待できる（例え日本国内にあったとしても）
    - （真偽に100％の自信はないが）S3はディスク保存なのに対し、CloudFrontはメモリor高速なSSDにあると思われるので高速
  - オリジンサーバーの負荷軽減にもつながる
- 可用性向上
  - オリジンサーバー障害時でもCDNキャッシュにより一部コンテンツの継続提供が可能
- セキュリティ強化
  - HTTPS対応
  - WAF
- キャッシュ設定を細かく制御できる
  - CDN上でA/Bテストやコンテンツ切り替えが可能
  - 圧縮や画像の自動最適化もサポートされていることが多い

## キャッシュを検討する

### フロントエンド資材

Next.jsのようなJavaScriptフレームワークを使用しており、ビルド資材をS3に格納し、CloudFrontで配信するというような場合の設定例

- staticファイル:
  - JSやCSS、publicフォルダにないimage等は、ファイル名にハッシュ値が設定されるのでURLが変わるため、長めの設定で問題ない
- 上記以外のhtml,publicフォルダやappディレクトリ直下にあるicon画像等の静的資材:
  - 上とは異なり、ファイル名が固定値(ex:index.html)であるため、短い時間が安全
  - もしくはno-cacheで毎回新鮮かを問い合わせるとか

### API

ユーザー固有の情報を返すようなAPIの場合はキャッシュ無効化(no-store)やプライベート化(private)にすべき。\
キャッシュが他のユーザーの情報を返してしまい事故リスクがあるため。

## Cache-Control

以下を見れば全てがわかる!!\
[Cache-Control - HTTP | MDN](https://developer.mozilla.org/ja/docs/Web/HTTP/Reference/Headers/Cache-Control)

気になった箇所だけちょっと補足

- privateとno-storeの違い
  - private: クライアント側のキャッシュに限定（CDNにはキャッシュしない）
  - no-store: キャッシュを完全に無効化
- max-ageとs-maxageの違い
  - max-age: レスポンスが生成されてから、新鮮である期間を示す（新鮮とみなす＝つまりキャッシュする時間）
  - s-maxage: max-ageと同じ意味だが、これは共有キャッシュ(CDN)特有の値となる

## 条件付きリクエストによる再検証

### If-Modified-Since + Last-Modified

- オリジンから`Last-Modified`が返却され、キャッシュはそれを保持
- キャッシュから`If-Modified-Since`に`Last-Modified`の値をセットし、このキャッシュって新鮮かどうかを確認
- オリジンは、200+コンテンツ or 304+コンテンツなしを返却

### If-None-Match + ETag

- オリジンから`ETag`が返却され、キャッシュはそれを保持
- 次のリクエスト時に `If-None-Match: "<ETagの値>"` を付けて問い合わせ
- オリジンは、200+コンテンツ or 304+コンテンツなしを返却

### どちらを使うか

- S3オリジンの場合はETagが自動で返却される
- カスタムオリジンの場合は返すヘッダ次第で決める
