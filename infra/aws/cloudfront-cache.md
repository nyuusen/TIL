# CloudFrontのキャッシュについて

## キャッシュする場所

`クライアント(ブラウザ)----CloudFront----オリジン` という構成の場合、キャッシュする場所としては以下がある。

- ブラウザ
- CloudFront(CDN)
※オリジンサーバ側にも何らかのキャッシュ機構があるかもしれないが話が逸れるので割愛

## ブラウザキャッシュ

ブラウザキャッシュは、ブラウザのメモリやストレージにデータを保持する形でキャッシュを実現する。  
どのように、どのくらいキャッシュを行うかは、CloudFrontから返却される`Cache-Control`ヘッダの設定値による。

## CloudFrontキャッシュ

キャッシュポリシーで設定する。キャッシュポリシーはビヘイビアごとに設定が可能。  
ビヘイビアにはパスパターンで対象の拡張子やファイルパスを元に対象を特定し、キャッシュ以外にもリクエスト・レスポンス周りやオリジンの設定が可能。

キャッシュポリシーでは、オリジンからCache-Controlが返却された場合、どのように扱う(それを適用する/無視してCloudFrontの設定を使用する等)かも設定できる。  
キャッシュ保持時間を表すTTLには、min,default,maxの項目がある（これがちょっとややこしい..）

- min: オリジンからの指定有無に関係なく、CloudFrontがキャッシュする最小時間
- default: オリジンから指定がなかったらこの値が使用される
- max: オリジンの指定がこの値を超えていた場合に使用される、CloudFrontがキャッシュする最大時間

## キャッシュを検討する

### フロントエンド資材

Next.jsのようなJavaScriptフレームワークを使用しており、ビルド資材をS3に格納し、CloudFrontで配信するというような場合の設定例

- staticファイル: 
  - JSやCSS、publicフォルダにないimage等は、ファイル名にハッシュ値が設定されるのでURLが変わるため、長めの設定で問題ない
- 上記以外のhtml,publicフォルダやappディレクトリ直下にあるicon画像等の静的資材: 
  - 上とは異なり、ファイル名が固定値(ex:index.html)であるため、短い時間が安全
  - もしくはno-cacheで毎回新鮮かを問い合わせるとか

### API

ユーザー固有の情報を返すようなAPIの場合はキャッシュ無効化(no-store, private等)にすべき。  
キャッシュが他のユーザーの情報を返してしまい事故リスクがあるため。

## Cache-Control

以下を見れば全てがわかる!!  
[Cache-Control - HTTP | MDN](https://developer.mozilla.org/ja/docs/Web/HTTP/Reference/Headers/Cache-Control)

気になった箇所だけちょっと補足します。

- privateとno-storeの違い
  - private: クライアント側のキャッシュに限定（CDNにはキャッシュしない）
  - no-store: キャッシュを完全に無効化
- max-ageとs-maxageの違い
  - max-age: レスポンスが生成されてから、新鮮である期間を示す（新鮮とみなす＝つまりキャッシュする時間）
  - s-maxage: max-ageと同じ意味だが、これは共有キャッシュ(CDN)特有の値となる