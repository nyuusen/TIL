# WAF

## 構成要素

- WebACL
- ルールグループ
- ルール

### WebACL

- 対象に関連付けるエントリポイントつまりWAFの入口に当たるもの
- WAFを適用したい対象（CloudFront/ALB/API Gateway）に紐づける事でトラフィックをチェックする
- 複数のルールやルールグループを含めることができる
- ルールの評価順序を管理する

### ルールグループ

- 複数のルールをまとめた論理的なグループ
- 再利用可能
- ルールグループとしてまとめた場合、優先度付けできるのはルールグループに対してとなる（ルールグループ内のルールに対して優先度を個別でつけることはできない）

### ルール

- 実際のトラフィックに対する評価条件とそれに対するアクションを記述する
  - 基本的にはIF→THEN(Allow, Block, Count)の形で定義する

## ルールグループとルールの使い分け

- 再利用性と管理性が高くなるので、基本的には再利用する or 複雑(例: Webアプリケーションに対する一般的なセキュリティ機構としてXSSとSQLインジェクションを自前で定義するを1つにまとめたい)といったような目的・用途があるならルールグループを使うと良い（と理解している）

## 優先度とは？

- 優先度の低いものから順に評価していく
- 同じWebACL内にあるルールやルールグループに対して一意に設定する必要がある
- 一致した時点でアクション(Allow, Block, Count)が実行され、**残りのルールは評価されない**
  - なので条件が厳しいルールを先に評価することで効率よくチェックが行える

## 複数のルールをPASSしたトラフィックのみ通したい場合は？

- WAFは最初にマッチしたルールでALLOWされたら以降のルールは評価されなくなる
- 1つのルールに複数の条件（Statement）をANDで書くことで、表題を実現できる

## Countアクションの使い道

- ルールにマッチしてもトラフィックを通過をブロックせず、ログだけ残す動作
- 例えば新しいルールの導入にあたり検証するため、BLOCKの前段階として使うとか