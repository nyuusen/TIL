# PrivateLinkを理解する

## PrivateLinkとは？

- サービスがVPC内にあるかのようにVPCをそれらのサービスにプライベートに接続できるようにするサービス
  - あるVPCから別のVPCのあるリソースをあたかも同一VPC内にホストされているかのように、プライベートIPアドレスを使用して接続することを可能にする
- 後述のVPCエンドポイントVPCエンドポイントサービスを使用して、上記の機能が実現することができ、その提供される機能（サービス）のことをPrivateLinkという
- IGW、NATデバイス、パブリックIPアドレス、DirectConnect、Site-to-Site VPN接続を使用する必要はない
  - セキュリティが向上するのはもちろん、NATゲートウェイ（インスタンス）やEIPが不要ということでコスト面でもメリットが大きい
- [AWS PrivateLink とは](https://docs.aws.amazon.com/ja_jp/vpc/latest/privatelink/what-is-privatelink.html)
- [AWS PrivateLink の概念](https://docs.aws.amazon.com/ja_jp/vpc/latest/privatelink/concepts.html)

## VPCエンドポイントとは？

- VPCと他サービス間でプライベート接続を可能にするコンポーネント
- **サービス利用側**のVPC内に作成する
- (インターフェイス型)VPCエンドポイントを作成するとENIが作成（アタッチ）される
  - VPCエンドポイントを作成するときは1つ以上のサブネットを選択するが、選択したサブネットそれぞれにENIが作成される

## VPCエンドポイントサービスとは？

- VPCと他サービス間でプライベート接続を可能にするコンポーネント
- **サービス提供側**のVPC内に作成する
- 実体はロードバランサー
  - NLB or GLBが必要
- VPCエンドポイントサービス側では、VPCエンドポイントの接続リクエストを承諾を行う必要がある

### なぜサービス提供側にNLBが必要なのか？（考察）

（そういう仕様だからというのは置いておいて、どうしてそのようになっているか考えてみた）

- PrivateLinkの思想はあくまでネットワークレイヤの透過的な疎通なので、L7レイヤのことは気にするべきでない（ALBでは実現不可）
  - L4レイヤであれば内部ネットワークで通信を延長できるイメージ
- 加えて、L7レイヤではHTTPリクエストの解釈等の負荷があるが、IPとポートだけで接続先を決めるL4レイヤは軽くてパフォーマンスも良い
- じゃあECSとかサーバーに直接繋げるのはダメなの？起動のたびにIP変わったりするし、そうなるとPrivateLinkも貼り直しになり色々微妙（そもそもL7レイヤでの通信じゃんという話ももちろんあるが）
- PrivateLinkは、あくまでネットワーク（VPC）のサービスだから、アプリケーションレイヤが立ち入るのは良くないよねという設計思想なのかもしれない
- ちなみに、NLBのターゲットにALBを指定することは可能

## VPCエンドポイントの種類

### インターフェイスタイプ

- プライベートIPが割り当てられたENIが作成される(これはEC2のようなもの...？)

### ゲートウェイタイプ

- ルートテーブルで送信先に対するターゲットとして指定する
  - このサブネットのこの宛先（プレフィックスリスト）の通信はS3/DyanamoDBに流すというやつ
- 内部的にENIやIPアドレスは作成されない（恐らく仮想ルータ的なものだけ）
- つまり、ルートテーブルだけでの制御(L3 IPレベルの単純な転送)なので、軽いしスケールしやすい
  - だから、通信容量が多そうなS3とDynamoDBだけなのだろうか...？

## インターフェースVPCエンドポイントの料金

- 時間課金: VPCエンドポイント1つあたり 0.014USD/1h
- データ処理量: 0.01USD/1PB

→これって多分ENI（EC2的な？）を内部で立てているための料金なのかも？

※ゲートウェイ型は、データ処理量のみ発生する

## 参考

- [【初心者向け】VPCエンドポイントとAWS PrivateLinkの違いを実際に構築して理解してみた | DevelopersIO](https://dev.classmethod.jp/articles/aws-vpcendpoint-privatelink-beginner/)
