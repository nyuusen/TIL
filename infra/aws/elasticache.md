# ElasticCache 入門

## ElastiCache とは

- 一言で表すと「フルマネージドのインメモリキャッシングサービス」
- Memcached または Redis プロトコルに互換性がある
- 特にリアルタイム性が必要な読み込み量が多いユースケースで活躍する
  - 端的にいうと高速なデータストア（キャッシュ）
- あくまでインメモリなので、ノードが落ちるとデータが消失するのでそこは注意が必要

### 構成要素

- ノード：最小構成要素でありインスタンス
- シャード：ノードのグループ(レプリケーション機能を使用する時に使うやつ)
- クラスタ：複数のシャードを束ねる
  - クラスタがあることで、例えばあるノードが落ちてしまっても、アプリケーション側からは1つのエンドポイントでアクセスできる(Redisの場合は)

### 料金

- 前提として、ElasticCache にはいくつかの種類がある
  - オンデマンド、リザーブド、サーバレス..
- オンデマンドの場合は、キャッシュノードタイプ(cache.t4g.micro)に応じて、時間あたりの料金が発生する
  - 詳細: [料金 - Amazon ElastiCache | AWS](https://aws.amazon.com/jp/elasticache/pricing/)

## ユースケース

- セッションストア
- レコメンデーション
- マルチプレイヤーゲームのランキングなどなど..

## 設計・実装のポイントどころ

- 基本的にはアプリケーションからキャッシュを確認し、なければデータストアへ確認、そしてキャッシュへの格納みたいな設計になることが多い
- 結果整合性を前提とする
  - プライマリからレプリカにデータをシャードしている場合、読み込むを行うレプリカ側にはすぐに反映されない
    - これは、書き込みも読み込むも同じノードで行ってしまうとコネクション枯渇や CPU 使用率の逼迫を避けるためにそのように設計されてしまう
  - そもそも結果整合性とは、データが分散されている環境でデータ更新が行われた場合、一定時間経過後に最終的な一貫性が担保されるという考え方(マイクロサービスの文脈でよく登場するイメージ)
- TTL に適切な値をセットする
  - データ量が増えるとノードのメモリが溢れてしまう問題がある
  - それを避けるために、一定時間経過後にデータが揮発するように設計すべき

## Memcached と Redis

- シンプルな Memcached と高機能な Redis
- 結論としては安全性でも機能面でも全てにおいてRedisを使用するのが良いと思われる
- [ElastiCacheはMemcachedとRedisのどっちを選ぶ？ | DevelopersIO](https://dev.classmethod.jp/articles/which-choice-redis-memcached/)

### Memcached

- クラスタはノードの追加や削除が可能(水平スケーリング)
- アプリケーション側で定期的にノードの状態をチェックする必要がある
- マルチスレッド(スペック上げると性能もその分上がる)
- 格納できるデータはstring型のみ
- 扱えるコマンドが少なく、基本はデータ追加と削除のみを使用する想定
- バックアップのサポートがされていない

### Redis

- クラスタにエンドポイントを持っている(Memcachedとの大きな違い)
  - なのでアプリケーション側で定期的にポーリングする必要ある
- レプリケーションをサポートしている
- シングルスレッド(スペックを上げてもMemcachedほど性能は上がらない)
- 格納できるデータ型は、stringに加え、List、Set、Sorted Set、Hash、Bit Array、HyperLogLogがある
- 機能が豊富で、正規表現を用いた曖昧検索などもある
- クラスターごとにスナップショットを取ることが可能。スナップショットから復元も可能。

## DynamoDBとの比較

以下の記事に比較しているセクションがあるので、少し考えてみる

- [ElastiCacheは良いサービス！！特徴や使い方をおさらいしましょ！ | DevelopersIO](https://dev.classmethod.jp/articles/elasticache-is-very-good-lets-review/)

> ElastiCacheはノードやクラスターの管理をユーザ側でしなければなりませんが、DynamoDBはその辺りの管理をしなくて良いのが便利

→セキュリティやエンジンのアップデート(サービスの更新)をユーザー側で行う必要があるという意味かな？

> DynamoDBは可用性担保のために書き込まれたデータを複数のAZに保存したり、接続にはSSLを用いるのでElastiCacheに比べるとやや書き込みが遅くなります。

> ElastiCacheは構成もユーザが選べるので通信元（クライアント）とノードを同一AZに寄せればより通信を早くするということも可能ですね

> また例えばセッション情報のような頻繁に書き/読み込みされるようなデータの場合にはリクエストの度に課金されていくDynamoDBだとElastiCacheに比べて料金が割高になる可能性があります。

→なるほど〜

まとめると、

- 最悪消失しても良いデータであり、書き込みと読み込みが頻繁に行われ、何より高速な通信したい→ElastiCache
- データを永続化したい→DynamoDB

## 参考

- [AWS 再入門 2022 AWS ElastiCache について | DevelopersIO](https://dev.classmethod.jp/articles/re-introduction-2022-amazon-elasticache/)
- [ElastiCache は良いサービス！！特徴や使い方をおさらいしましょ！ | DevelopersIO](https://dev.classmethod.jp/articles/elasticache-is-very-good-lets-review/)
